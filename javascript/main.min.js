// Author: Mohamed Mostafa
// Project: Meal App
// Version: 1.0.0

const app = {
  data: () => ({
    meals: [],
    allMeals: [],
    categories: [],
    loading: !0,
    error: null,
    searchQuery: "",
    selectedCategory: "",
    mealsToShow: 6,
    favorites: [],
    currentTab: "all",
    selectedMeal: null,
    showModal: !1,
  }),
  computed: {
    currentMeals() {
      return "favorites" === this.currentTab ? this.favorites : this.meals;
    },
    currentDisplayedMeals() {
      return "favorites" === this.currentTab
        ? this.favorites
        : this.meals.slice(0, this.mealsToShow);
    },
  },
  methods: {
    async fetchMeals() {
      try {
        (this.loading = !0), (this.error = null);
        let e = await fetch(
            "https://www.themealdb.com/api/json/v1/1/search.php?s=a"
          ),
          t = await e.json();
        (this.allMeals = t.meals ?? []),
          (this.meals = this.allMeals),
          this.extractCategories();
      } catch (s) {
        this.error =
          "Failed to load meals. Please check your internet connection.";
      } finally {
        this.loading = !1;
      }
    },
    extractCategories() {
      let e = new Set();
      this.allMeals.forEach((t) => {
        t.strCategory && e.add(t.strCategory);
      }),
        (this.categories = [...e].sort());
    },
    async searchMeals() {
      if (!this.searchQuery.trim()) {
        (this.meals = this.allMeals),
          this.applyCategoryFilter(),
          (this.mealsToShow = 6);
        return;
      }
      try {
        this.loading = !0;
        let e = await fetch(
            `https://www.themealdb.com/api/json/v1/1/search.php?s=${this.searchQuery}`
          ),
          t = await e.json();
        (this.meals = t.meals ?? []),
          this.applyCategoryFilter(),
          (this.mealsToShow = 6);
      } catch {
        this.meals = [];
      } finally {
        this.loading = !1;
      }
    },
    filterByCategory() {
      this.applyCategoryFilter(), (this.mealsToShow = 6);
    },
    applyCategoryFilter() {
      if (!this.selectedCategory) {
        this.meals = this.searchQuery ? this.meals : this.allMeals;
        return;
      }
      this.meals = this.meals.filter(
        (e) => e.strCategory === this.selectedCategory
      );
    },
    loadMore() {
      this.mealsToShow < this.meals.length && (this.mealsToShow += 6);
    },
    isFavorite(e) {
      return this.favorites.some((t) => t.idMeal === e);
    },
    toggleFavorite(e) {
      this.isFavorite(e.idMeal)
        ? (this.favorites = this.favorites.filter((t) => t.idMeal !== e.idMeal))
        : this.favorites.push(e),
        this.saveFavoritesToStorage();
    },
    saveFavoritesToStorage() {
      try {
        localStorage.setItem("favorites", JSON.stringify(this.favorites));
      } catch {}
    },
    loadFavoritesFromStorage() {
      try {
        let e = localStorage.getItem("favorites");
        this.favorites = e ? JSON.parse(e) : [];
      } catch {
        this.favorites = [];
      }
    },
    showMealDetails(e) {
      (this.selectedMeal = e),
        (this.showModal = !0),
        (document.body.style.overflow = "hidden"),
        setTimeout(() => {
          let e = document.getElementById("mealModal");
          e && (e.classList.add("show"), (e.style.display = "block"));
        }, 10);
    },
    closeModal() {
      let e = document.getElementById("mealModal");
      e && e.classList.remove("show"),
        setTimeout(() => {
          (this.showModal = !1),
            (this.selectedMeal = null),
            e && (e.style.display = "none"),
            (document.body.style.overflow = "auto");
        }, 300);
    },
    getIngredients(e) {
      let t = [];
      for (let s = 1; s <= 20; s++) {
        let a = e[`strIngredient${s}`],
          l = e[`strMeasure${s}`];
        a && a.trim() && t.push({ ingredient: a, measure: l || "" });
      }
      return t;
    },
  },
  mounted() {
    this.loadFavoritesFromStorage(), this.fetchMeals();
  },
};
document.addEventListener("DOMContentLoaded", () => {
  Vue.createApp(app).mount("#app");
});
